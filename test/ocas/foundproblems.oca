// From hawki, with ">" and a number
if DPR.CATG == "CALIB" and DPR.TECH == "IMAGE" and DPR.TYPE == "DARK"
  and INSTRUME like "%HAWKI%"
  and TPL.NEXP > 2 then
{
  RAW.TYPE = "DARK";
  REFLEX.CATG = "DARK";
}

// From amber_wkf, with , in value
if (DPR.CATG=="CALIB") and DPR.TYPE=="WAVE,3TEL" and (TPL.ID like "%std_acq%" or TPL.ID like "%p2vm%" or TPL.ID like "%P2VM%") then
{
  RAW.TYPE="3P2V";
  DO.CATG="AMBER_3WAVE";
  PACK.DIR="P2VM";
  CATG="CALIB";
}


// Based on cr2re_wkf. Ensures that REFLEX.CATG is always set to something.
if (T) then
{
   REFLEX.CATG="UNDEFINED";
}

// Based on cr2re_wkf. Test on types
if PRO.SATG is string then
{
  REFLEX.SATG="ABCD";
}

// Based on cr2re_wkf. Use keyword as value.
if PRO.SATG == "QQ" then
{
  REFLEX.SATG=PRI.SATG;
}

// Based on efosc_spec, using !=
if INS.SLIT.NAME!="slit#5.0" then
{
  RAW.TYPE = "SCREEN";
}

// Based on efosc_spec, using #
if INS.SLIT.NAME=="slit#5.0" then
{
  RAW.TYPE = "SCREEN";
}



//ORGANIZATION

// From HAWKI, with AS
select execute(SKY_FLATS) from inputFiles where RAW.TYPE=="FLAT_TWILIGHT"
  group by DET.NCORRS.NAME,DET.DIT,DET.NDIT,INS.FILT1.NAME,INS.FILT2.NAME,OBS.START as (TPL_A,tpl);

// From HAWKI, without AS
select execute(DETECTOR_NOISE_COMPUTATION) from inputFiles where RAW.TYPE == "DARK" and DET.NDIT==1 group by ARCFILE;

// From HAWKI, normal action
action DARKS
{
  minRet=0; maxRet=1;
  select file as REFERENCE_DARK from inputFiles where
    REFLEX.CATG=="REFERENCE_DARK"
    and inputFile.DET.DIT==DET.DIT
    and inputFile.DET.NDIT==DET.NDIT
    and inputFile.DET.NCORRS.NAME==DET.NCORRS.NAME;

  recipe hawki_dark_combine;

  product MASTER_DARK { PRO.CATG="MASTER_DARK";}
  product DIFFIMG_DARK { PRO.CATG="DIFFIMG_DARK";}
  product DIFFIMG_STATS_DARK { PRO.CATG="DIFFIMG_STATS_DARK";}

}

// from 4most_wkf, has a "." in a value, and no inputselection
action ACTION_CALIB_IMG
{

recipe rrrecipe_calib;
product IMG_CALIBRATED {
    REFLEX.CATG = "IMG_CALIBRATED";
    PRO.CATG = "IMG_CALIBRATED";
    PRO.EXT="tpl_0000.fits";}
}

// Based on amber_wkf, equation in selection.
// TODO: Support
action ACTION_SCIENCE_FRINGE
{
  minRet=1; maxRet=1;
  select file as P2VM_REDUCED from calibFiles where
    DO.CATG=="P2VM_REDUCED"
//    and (inputFile.MJD-OBS - MJD-OBS) < 0.30 and (inputFile.MJD-OBS - MJD-OBS) > 0.0
  ;

 recipe amber_SciCal ;
  product SCIENCE_REDUCED { PRO.CATG="SCIENCE_REDUCED"; }
}

// Based on amber_wkf, uses parameters.
// TODO: support
action ACTION_SCIENCE_FRINGE
{
  minRet=1; maxRet=1;
  select file as P2VM_REDUCED from calibFiles where
    DO.CATG=="P2VM_REDUCED";

// recipe amber_SciCal { "--binning=1"; "--select=FALSE"; }
  recipe amber_SciCal ;
  product SCIENCE_REDUCED { PRO.CATG="SCIENCE_REDUCED"; }
}
